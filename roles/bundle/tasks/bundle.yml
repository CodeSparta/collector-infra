---
####### Create Unified PlatformOne.tar.gz Tarball with all offline deploy requirements
- name: '{{ ansible_name_module }} | stat | Check for pre-existing PlatformOne.tar.gz.sha256'
  stat:
    path: '/tmp/PlatformOne.tar.gz.sha256'
  register: p1tar_sha_check

###### Download OpenShift Docker Images from Quay.io to File: /root/PlatformOne/Mirror/v2
- name: '{{ ansible_name_module }} | block | Download OpenShift images'
  block:

    ####### Purge preexisting bundles
    - name: '{{ ansible_name_module }} | file | Purge pre-existing bundles'
      file:
        path: "{{ local_home }}/PlatformOne.tar.gz"
        state: absent

    ####### Build Unified Bundle
    - name: '{{ ansible_name_module }} | command:tar | build tarball bundle of all artifacts'
      command:
        "tar -cvzf /tmp/PlatformOne.tar.gz -C {{ local_home }} PlatformOne"
      args:
        creates: "{{ local_home }}/PlatformOne.tar.gz"
        warn: false

    ####### SHA256sum PlatformOne.tar.gz
    - name: '{{ ansible_name_module }} | stat:sha256 | SHA PlatformOne.tar.gz'
      stat:
        path: "/tmp/PlatformOne.tar.gz"
        checksum_algorithm: sha256
        get_checksum: yes
      register: p1tar_sha256

    ####### Write SHA file
    - name: '{{ ansible_name_module }} | copy | Write PlatformOne.tar.gz.sha256'
      copy:
        dest: "/tmp/PlatformOne.tar.gz.sha256"
        content: "{{ p1tar_sha256 }} PlatformOne.tar.gz"

  ####### Block Conditionals
  when: not p1tar_sha_check.stat.exists

####### Bundle PlatformOne.tar.gz with unpack + launch utilities
# name: '{{ ansible_name_module }} | role | archive | Bundle PlatformOne.tar.gz with auxilary files'
# archive:
#   path:
#   - '/tmp/PlatformOne.tar.gz.sha256'
#   - '/tmp/PlatformOne.tar.gz'
#   - '/tmp/registry.yml'
#   - '/tmp/registry.sh'
#   dest: '{{ local_home }}/PlatformOne/{{ cloud_provider }}-{{ target_environment }}-{{ name_cluster_vpc }}-p1bundle.tar'
#   format: tar

####### Build Unified Bundle
- name: '{{ ansible_name_module }} | command:tar.cvf | Build unified bundle with auxilary unpack+launch utilities'
  command:
    "tar -cvf {{ local_home }}/PlatformOne/{{ cloud_provider }}-{{ target_environment }}-{{ name_cluster_vpc }}-p1bundle.tar -C /tmp PlatformOne.tar.gz.sha256 PlatformOne.tar.gz registry.yml registry.sh"
  args:
    creates: "{{ local_home }}/PlatformOne/{{ cloud_provider }}-{{ target_environment }}-{{ name_cluster_vpc }}-p1bundle.tar"
    warn: false
